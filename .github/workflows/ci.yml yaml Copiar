name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  test-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Instala PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none
          extensions: mbstring, curl, xml, sqlite3

      - name: Instala utilitÃ¡rios
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Sobe API
        run: |
          php -S 127.0.0.1:8000 backend/server_pro.php > api.log 2>&1 &
          sleep 2
          curl -sS http://127.0.0.1:8000/ || (cat api.log && exit 1)

      - name: Smoke tests
        run: |
          # init tenant + admin
          curl -sS -X POST http://127.0.0.1:8000/api/auth/init \
            -H 'Content-Type: application/json' \
            -d '{"tenant_name":"Acme","tenant_slug":"acme","admin_name":"Admin","email":"admin@acme.test","password":"test1234"}' | jq .

          # login
          TOKEN=$(curl -sS -X POST http://127.0.0.1:8000/api/auth/login \
            -H 'Content-Type: application/json' \
            -d '{"email":"admin@acme.test","password":"test1234"}' | jq -r .token)

          test -n "$TOKEN"

          # chama alguns endpoints
          curl -sS -H "Authorization: Bearer $TOKEN" http://127.0.0.1:8000/api/templates | jq .
          curl -sS -H "Authorization: Bearer $TOKEN" "http://127.0.0.1:8000/api/metrics/messages?from=2025-01-01&to=2025-12-31" | jq .
